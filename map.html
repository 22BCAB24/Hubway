<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map_canvas { height: 100% }
    </style>
    <script type="text/javascript"
      src="http://maps.googleapis.com/maps/api/js?&sensor=false">
    </script>
    <script type="text/javascript">
var map;
var route;
var directionsDisplay;
var flightPath;
var directionsService = new google.maps.DirectionsService();
var bicyclingLayer = new google.maps.BicyclingLayer();
function initialize() {
    
    var boston = new google.maps.LatLng(42.340592,-71.09489);
    var myMapOptions = {
        center: boston,
        zoom: 13,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map_canvas"), myMapOptions);
    
    var myRendererOptions = {
        suppressMarkers: true,
        suppressInfoWindows: false,
        suppressBicyclingLayer: true,
    };
    directionsDisplay = new google.maps.DirectionsRenderer(myRendererOptions);
    directionsDisplay.setMap(map);
    directionsDisplay.setPanel(document.getElementById("directionsPanel"));
    
    var myPolyLineOptions = {
        strokeColor: "#FF0000",
        strokeOpacity: 0.5,
        strokeWeight: 3,
    }
    flightPath = new google.maps.Polyline(myPolyLineOptions);
    flightPath.setMap(map);

}

function show_bike_layer(){
    bicyclingLayer.setMap(map);
}
function hide_bike_layer(){
    bicyclingLayer.setMap(null);
}
function check_bike_layer(){
    if(document.getElementById('bike_checkbox').checked) { show_bike_layer() }
    else { hide_bike_layer() }
}

function next(i){
    // returns i+1, or 0 if that would be off the end of the route
    return (i*1+1 < route_length) ? (i+1) : 0;
}

function get_coords(i){
    return new google.maps.LatLng(route[i].lat, route[i].long)
    //return ""+route[i].lat + ',' + route[i].long;
}

function make_next_button(i){
    var container = document.getElementById("nextPanel");
    container.innerHTML="This is leg "+(i*1)+" ";
    var button = document.createElement("input");
    button.type = "button"
    button.value = "Next";
    button.id = i;
    button.onclick = function(){
        calc_route_leg(this.id*1+1);
    }
    container.appendChild(button);
} 

function show_route_leg(i, directionResult) {
    directionsDisplay.setDirections(directionResult);
    
    var myRoute = directionResult.routes[0].legs[0];
    var overview_path = directionResult.routes[0].overview_path;
    
    var start = get_coords(i);
    var index_of_start = -1;
    var path = flightPath.getPath();
    path.forEach(function(element,index){
        if (element.equals(start)) { index_of_start = index; }
    });
    if (index_of_start<0) {
        // can't find the coarse start point, probably already updated this leg.
        return;
    }
    path.removeAt(index_of_start);
    for (var j = 0; j<overview_path.length; j++){
        path.insertAt(index_of_start+j, overview_path[j]);
    }
}
function calc_route_leg(i){
    if (i == route.length) { i = 0 ;}
    var start = get_coords(i);
    var end = get_coords(next(i));
    var request = {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.BICYCLING,
    };
    directionsService.route(request, function(result, status) {
        if (status == google.maps.DirectionsStatus.OK) {
            show_route_leg(i, result);
            make_next_button(i);
        }
        else {
            document.getElementById("directionsPanel").innerHTML="Error fetching directions";
        }
    });
}

function plotroute(route){
    var flightPlanCoordinates = [];
    for (var i = 0; i < route.length; i++){
        station = route[i];
        
        // Create a Google LatLng object to pass to the Google Marker
        var point = new google.maps.LatLng(station.lat, station.long);
        // save it in the polyline coordinates list
        flightPlanCoordinates[i] = point;
        
        // Create the Google Marker Point with the LatLng object
        var marker = new google.maps.Marker({
            position: point, 
            map: map,
            title: station.name,
            id: i*1,
        });
        
        // Create an Event Listener that does something when user clicks a station
        google.maps.event.addListener(marker, 'click',
            function(){
                calc_route_leg(this.id);
            });
    }
    // close the loop on the flight plan
    flightPlanCoordinates[i] = flightPlanCoordinates[0];
    
    // draw the flight plan
    flightPath.setPath(flightPlanCoordinates)

}

function loadroute() {
    var xobj = new XMLHttpRequest();
    xobj.overrideMimeType("application/json");
    xobj.open('GET', 'route.json', true);
    xobj.onreadystatechange = function () {
        if (xobj.readyState == 4) {
            var jsonTexto = xobj.responseText;
            route = JSON.parse(jsonTexto);
            plotroute(route);
            make_next_button(0);
        }
    }
    xobj.send(null);
}

loadroute();


    </script>
  </head>
  <body onload="initialize()">
    <div id="map_canvas" style="float:left;width:70%; height:100%"></div>
    <div id="right_panel" style="float:right;width:30%;height 100%">
        <input type='checkbox' onchange='check_bike_layer();' id='bike_checkbox' label='Show bike routes' /> show bike routes.
        <div id="nextPanel"></div>
        <div id="directionsPanel"></div>
    </div>
  </body>
</html>